#!/usr/bin/env node
const fs = require('fs/promises');
const axios = require('axios');
const potrace = require('potrace');
const { optimize } = require('svgo');
const os = require('os');
const path = require('path');

/**
 * ğŸ­ The Image-to-SVG Alchemist - A Tool for Digital Transmutation
 *
 * "From pixels coarse, a vector's grace,
 * This script bestows a timeless face.
 * With algorithms sharp and logic keen,
 * A vibrant, perfect SVG is seen."
 *
 * - The Digital Metaphor Maestro
 */
async function convertImageToTinySvg(imageUrl, outputPath) {
  try {
    console.log(`ğŸŒ âœ¨ IMAGE QUEST AWAKENS! Fetching from: ${imageUrl}`);
    const response = await axios.get(imageUrl, { responseType: 'arraybuffer' });
    const tempFileName = `temp_icon_${Date.now()}${path.extname(imageUrl) || '.png'}`;
    const tempFilePath = path.join(os.tmpdir(), tempFileName);
    await fs.writeFile(tempFilePath, response.data);
    
    console.log('ğŸ¨ Tracing the artistic soul of the image... with color!');
    const svgString = await new Promise((resolve, reject) => {
      potrace.posterize(tempFilePath, { steps: 4 }, (err, svg) => {
        fs.unlink(tempFilePath, (unlinkErr) => {
          if (unlinkErr) console.error(`ğŸŒ™ âš ï¸ Gentle reminder: Failed to clean up temp file: ${tempFilePath}`, unlinkErr);
        });
        if (err) return reject(err);
        resolve(svg);
      });
    });
        
    console.log('âœ¨ Performing enchanted alchemy to shrink the vector spell...');
    const result = optimize(svgString, {
      multipass: true,
    });
    const optimizedSvg = result.data;

    await fs.writeFile(outputPath, optimizedSvg);
    console.log(`ğŸ‰ âœ¨ SVG MASTERPIECE COMPLETE! Saved to: ${outputPath}`);

  } catch (creativeChallenge) {
    console.error(`ğŸ’¥ ğŸ˜­ ALCHEMY TEMPORARILY HALTED!`);
    if (axios.isAxiosError(creativeChallenge) && creativeChallenge.response) {
      console.error(`ğŸŒ©ï¸ The server responded with a ${creativeChallenge.response.status} status.`);
    } else {
      console.error(`ğŸŒ©ï¸ Temporary setback: ${creativeChallenge.message}`);
    }
    console.log(`ğŸ­ But the show must go on...`);
  }
}

// ğŸŒŸ The Grand Entrance - Where the magic begins
(async () => {
  const imageUrl = process.argv[2];
  const outputPath = process.argv[3];

  if (!imageUrl || !outputPath) {
    console.log('ğŸŒ™ âš ï¸ Gentle reminder: Please provide an image URL and an output path.');
    console.log('Usage: ./scripts/image-to-svg <imageUrl> <outputPath>');
    process.exit(1);
  }

  await convertImageToTinySvg(imageUrl, outputPath);
})();
